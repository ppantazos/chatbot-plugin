var be=Object.defineProperty;var Ce=(d,e,s)=>e in d?be(d,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):d[e]=s;var x=(d,e)=>()=>(d&&(e=d(d=0)),e);var Te=(d,e)=>()=>(e||d((e={exports:{}}).exports,e),e.exports);var l=(d,e,s)=>Ce(d,typeof e!="symbol"?e+"":e,s);var j,ie=x(()=>{j=class{constructor(e){l(this,"config",{});l(this,"handler","");l(this,"openaiApiKey","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");this.handler=e,this.init()}init(){let e=document.querySelector(`#wp-script-module-data-${this.handler}`);e&&(this.config=JSON.parse(e.textContent))}fetch(){return this.config}getOpenAIApiKey(){return this.openaiApiKey}}});var $,se=x(()=>{$=class{constructor(e,s,o,c,a){l(this,"config",{});l(this,"onDataReceived");l(this,"onTrackSubscribed");l(this,"onTrackUnsubscribed");l(this,"onDisconnect");l(this,"sessionToken",null);l(this,"sessionInfo",null);l(this,"room",null);l(this,"webSocket",null);l(this,"onAvatarSpeechStart",null);l(this,"onAvatarSpeechEnd",null);this.config=e,this.onDataReceived=s,this.onTrackSubscribed=o,this.onTrackUnsubscribed=c,this.onDisconnect=a,this.audioStream=null,this.existingStream=null,this.audioTrackPublication=null,this.isMuted=!1,this.audioContext=null,this.analyser=null,this.microphone=null}async getSessionToken(){let s=await(await fetch(`${this.config.serverUrl}/v1/streaming.create_token`,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.config.apiKey}})).json();this.sessionToken=s.data.token}async connectWebSocket(e){let s=new URLSearchParams({session_id:e,session_token:this.sessionToken,silence_response:!1,opening_text:"",stt_language:"en",enable_tts:!0,enable_stt:!1}),o=`wss://${new URL(this.config.serverUrl).hostname}/v1/ws/streaming.chat?${s}`;this.webSocket=new WebSocket(o),this.webSocket.addEventListener("message",c=>{try{let a=JSON.parse(c.data);this.handleWebSocketMessage(a)}catch{}}),this.webSocket.addEventListener("open",async()=>{}),this.webSocket.addEventListener("error",c=>{}),this.webSocket.addEventListener("close",c=>{})}handleWebSocketMessage(e){e.type==="user_speech_start"?this.onVoiceInputStart?.():e.type==="user_speech_end"?this.onVoiceInputEnd?.():e.type==="avatar_speech_start"?this.onAvatarSpeechStart?.():e.type==="avatar_speech_end"?this.onAvatarSpeechEnd?.():e.type==="user_talking_message"||(e.type==="avatar_talking_message"?this.onDataReceived?.(new TextEncoder().encode(JSON.stringify({type:"avatar_talking_message",message:e.message||e.text||""}))):e.type==="avatar_end_message"&&this.onDataReceived?.(new TextEncoder().encode(JSON.stringify({type:"avatar_end_message",message:e.message||e.text||""}))))}async createSession(){this.sessionToken||await this.getSessionToken();let s=await(await fetch(`${this.config.serverUrl}/v1/streaming.new`,{method:"POST",headers:{Accept:"application/json","Content-type":"application/json","X-Api-Key":this.config.apiKey},body:JSON.stringify({quality:"medium",version:"v2",avatar_id:this.config.avatarId,knowledge_base_id:this.config.knowledgeBaseId})})).json();this.sessionInfo=s.data,this.createRoom(),this.handleRoomEvents(),await this.room.prepareConnection(this.sessionInfo.url,this.sessionInfo.access_token),await this.connectWebSocket(this.sessionInfo.session_id)}async startStreaming(){this.sessionInfo||await this.createSession(),await fetch(`${this.config.serverUrl}/v1/streaming.start`,{method:"POST",headers:{"Content-Type":"application/json","X-api-key":this.config.apiKey},body:JSON.stringify({session_id:this.sessionInfo.session_id})}),await this.room.connect(this.sessionInfo.url,this.sessionInfo.access_token),await new Promise(e=>setTimeout(e,500)),document.dispatchEvent(new Event("streamSessionStarted"))}async sendText(e,s="repeat"){if(this.sessionInfo)try{let o=await fetch(`${this.config.serverUrl}/v1/streaming.task`,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.config.apiKey},body:JSON.stringify({session_id:this.sessionInfo.session_id,text:e,task_type:s})})}catch{}}async closeSession(){this.sessionInfo&&(await fetch(`${this.config.serverUrl}/v1/streaming.stop`,{method:"POST",headers:{"Content-Type":"application/json","X-Api-Key":this.config.apiKey},body:JSON.stringify({session_id:this.sessionInfo.session_id})}),this.webSocket&&this.webSocket.close(),this.room&&this.room.disconnect(),document.dispatchEvent(new Event("streamSessionClosed")),this.sessionInfo=null,this.room=null,this.sessionToken=null)}createRoom(){this.room=new LivekitClient.Room({adaptiveStream:!0,dynacast:!0,videoCaptureDefaults:{resolution:LivekitClient.VideoPresets.h720.resolution}})}handleRoomEvents(){this.room.on(LivekitClient.RoomEvent.DataReceived,(e,s,o,c)=>{this.onDataReceived(e)}),this.room.on(LivekitClient.RoomEvent.TrackSubscribed,this.onTrackSubscribed),this.room.on(LivekitClient.RoomEvent.TrackUnsubscribed,this.onTrackUnsubscribed),this.room.on(LivekitClient.RoomEvent.Disconnected,this.onDisconnect)}setExistingStream(e){this.existingStream=e}async startVoiceInput(e=null){}toggleMute(){if(this.isMuted=!this.isMuted,this.audioTrackPublication)this.audioTrackPublication.setMuted(this.isMuted);else if(this.room?.localParticipant){for(let e of this.room.localParticipant.trackPublications.values())if(e.source===LivekitClient.Track.Source.Microphone){e.setMuted(this.isMuted);break}}return this.isMuted}getAudioLevel(){return 0}cleanupVoiceInput(){this.audioStream=null,this.audioContext=null,this.analyser=null,this.microphone=null,this.audioTrackPublication=null}}});var V,ne=x(()=>{V=class{constructor(e){l(this,"chatContainer",null);l(this,"messageParts",[]);l(this,"currentStreamingElement",null);this.chatContainer=e,this.messageParts=[],this.currentStreamingElement=null}append(e){this.messageParts.push(e)}reset(){this.messageParts=[]}clearHistory(){this.chatContainer&&(this.chatContainer.innerHTML=""),this.currentStreamingElement=null,this.reset()}getMessageParts(){return this.messageParts}output(...e){let s=document.createElement("p");s.classList.add(...e),s.textContent=this.messageParts.join(""),this.chatContainer.appendChild(s),this.reset()}outputStreaming(...e){this.currentStreamingElement||(this.currentStreamingElement=document.createElement("p"),this.currentStreamingElement.classList.add(...e),this.currentStreamingElement.textContent="",this.chatContainer.appendChild(this.currentStreamingElement)),this.currentStreamingElement.textContent=this.messageParts.join(""),this.chatContainer.scrollTop=this.chatContainer.scrollHeight}finalizeStreaming(...e){this.currentStreamingElement&&(this.currentStreamingElement=null),this.reset()}clearCurrent(){this.currentStreamingElement&&(this.currentStreamingElement=null),this.reset()}}});var K,oe=x(()=>{K=class{constructor(e){l(this,"config",{});l(this,"conversationId",null);l(this,"visitorId",null);this.serverUrl="https://app.sellembedded.com/api/v1",this.apiKey=e}async initUserConversation(){let s=await(await fetch(`${this.serverUrl}/conversations/userConversation/init`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({visitorId:this.visitorId})})).json();this.conversationId=s.data._id}async completeUserConversation(){this.conversationId&&(await fetch(`${this.serverUrl}/conversations/userConversation/${this.conversationId}/status`,{method:"PATCH",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({status:"completed"})}),this.conversationId=null)}async sendMessage(e,s){this.conversationId&&await fetch(`${this.serverUrl}/messages/userMessages/init`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({conversationId:this.conversationId,isFromUser:s,content:e})})}async initVisitor({ip:e,location:s=null,conversationId:o=null}){let a=await(await fetch(`${this.serverUrl}/visitors/init`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({ip:e,location:s,conversationId:o})})).json();return this.visitorId=a?.data?.id??null,a}async updateVisitorTalkedToChat({visitorId:e=this.visitorId,talkedToChat:s}){if(!e)throw new Error("visitorId is required to update talkedToChat status");await fetch(`${this.serverUrl}/visitors/${e}/talkedToChat`,{method:"PATCH",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({talkedToChat:s})})}async getAccountConfig(){let s=await(await fetch(`${this.serverUrl}/account/config`,{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`}})).json();return this.config=s?.data?.config??{},this.config}}});var J,ae=x(()=>{J=class{constructor(){this.audioStream=null,this.mediaRecorder=null,this.audioChunks=[],this.isRecording=!1,this.audioContext=null,this.analyser=null,this.microphone=null,this.silenceCheckInterval=null,this.speechTimeout=null,this.speechStartTime=null,this.onAudioLevel=null,this.onRecordingComplete=null,this.onError=null,this.isMobileDevice=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}async initialize(e=null){try{return e&&e.active?this.audioStream=e:this.audioStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3}}),this.audioStream.getAudioTracks().forEach(s=>{s.enabled||(s.enabled=!0)}),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.analyser=this.audioContext.createAnalyser(),this.microphone=this.audioContext.createMediaStreamSource(this.audioStream),this.analyser.fftSize=256,this.microphone.connect(this.analyser),this.audioStream}catch(s){throw this.onError?.(s),s}}async startRecording(e=.005,s=1e3){if(!this.audioStream)throw new Error("Microphone not initialized. Call initialize() first.");if(!this.isRecording){this.audioChunks=[];try{this.audioChunks=[];let o="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(o)||(o="audio/webm",MediaRecorder.isTypeSupported(o)||(o="audio/mp4",MediaRecorder.isTypeSupported(o)||(o="")));let c=o?{mimeType:o}:{};this.mediaRecorder=new MediaRecorder(this.audioStream,c),this.mediaRecorder.ondataavailable=a=>{a.data&&a.data.size>0&&this.audioChunks.push(a.data)},this.mediaRecorder.onstop=()=>{let a=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType||"audio/webm"});this.isRecording=!1,this.onRecordingComplete&&this.onRecordingComplete(a)},this.mediaRecorder.onerror=a=>{this.onError?.(a.error)};try{this.mediaRecorder.start(100),this.isRecording=!0,setTimeout(()=>{this.mediaRecorder.state!=="recording"&&this.onError?.(new Error("MediaRecorder failed to start"))},100)}catch(a){throw this.isRecording=!1,this.onError?.(a),a}if(this.analyser){let a=null,k=!1,b=setInterval(()=>{if(!this.isRecording){clearInterval(b);return}let S=this.getAudioLevel()>e;S?(a=null,k=!1,this.speechTimeout&&(clearTimeout(this.speechTimeout),this.speechTimeout=null)):!S&&this.isRecording&&!k&&(a===null&&(a=Date.now()),Date.now()-a>s&&(k=!0,clearInterval(b),this.silenceCheckInterval=null,this.stopRecording()))},100);this.silenceCheckInterval=b}}catch(o){throw this.onError?.(o),o}}}handleSpeechEnd(){}async stopRecording(){return!this.isRecording||!this.mediaRecorder?null:(this.silenceCheckInterval&&(clearInterval(this.silenceCheckInterval),this.silenceCheckInterval=null),this.speechTimeout&&(clearTimeout(this.speechTimeout),this.speechTimeout=null),this.mediaRecorder.state==="recording"&&(this.mediaRecorder.stop(),setTimeout(()=>{if(this.isRecording&&this.audioChunks.length>0){let e=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType||"audio/webm"});this.isRecording=!1,this.onRecordingComplete&&this.onRecordingComplete(e)}},500)),null)}getAudioLevel(){if(!this.analyser)return 0;let e=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(e);let s=0;for(let o=0;o<e.length;o++)s+=e[o];return s/e.length/255}isActive(){return this.audioStream!==null&&this.audioStream.active&&this.audioStream.getAudioTracks().some(e=>e.readyState==="live")}cleanup(){if(this.isRecording&&this.mediaRecorder)try{this.mediaRecorder.state==="recording"&&this.mediaRecorder.stop()}catch{}this.silenceCheckInterval&&(clearInterval(this.silenceCheckInterval),this.silenceCheckInterval=null),this.speechTimeout&&(clearTimeout(this.speechTimeout),this.speechTimeout=null),this.audioStream&&this.audioStream.getTracks().forEach(e=>e.stop()),this.audioContext&&this.audioContext.close().catch(()=>{}),this.audioStream=null,this.mediaRecorder=null,this.audioChunks=[],this.isRecording=!1,this.audioContext=null,this.analyser=null,this.microphone=null}async resumeAudioContext(){if(this.audioContext&&this.audioContext.state==="suspended")try{await this.audioContext.resume()}catch{}}}});var N,re=x(()=>{N=class{constructor(e){this.apiKey=e,this.baseUrl="https://api.openai.com/v1"}async transcribeAudio(e){try{let s=new FormData;s.append("file",e,"audio.webm"),s.append("model","whisper-1"),s.append("language","en");let o=await fetch(`${this.baseUrl}/audio/transcriptions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`},body:s});if(!o.ok){let a=await o.json().catch(()=>({}));throw new Error(`OpenAI API error: ${o.status} - ${a.error?.message||o.statusText}`)}return(await o.json()).text?.trim()||""}catch(s){throw s}}async chatCompletion(e,s=[],o="You are a helpful AI assistant."){try{let c=[{role:"system",content:o},...s,{role:"user",content:e}],a=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:"gpt-4",messages:c,stream:!0,temperature:.7})});if(!a.ok){let k=await a.json().catch(()=>({}));throw new Error(`OpenAI API error: ${a.status} - ${k.error?.message||a.statusText}`)}return a.body}catch(c){throw c}}async parseStreamingResponse(e,s,o,c){let a=e.getReader(),k=new TextDecoder,b="";try{for(;;){let{done:E,value:S}=await a.read();if(E){o?.();break}b+=k.decode(S,{stream:!0});let H=b.split(`
`);b=H.pop()||"";for(let R of H)if(R.startsWith("data: ")){let T=R.slice(6);if(T==="[DONE]"){o?.();return}try{let m=JSON.parse(T).choices?.[0]?.delta?.content;m&&s?.(m)}catch{}}}}catch(E){c?.(E)}finally{a.releaseLock()}}}});var Ee=Te(()=>{ie();se();ne();oe();ae();re();async function Ie(d,e=5e3){let s=Date.now();for(;Date.now()-s<e;){let o=document.getElementById(d);if(o)return o;await new Promise(c=>setTimeout(c,100))}return null}document.addEventListener("DOMContentLoaded",async function(){try{let le=function(){y&&y.clearHistory(),v=!1,G=!1,w=!1,u=!1,B=[],U=!1,Q(),h("Voice idle",!1),Y(),n.cleanup(),c&&(c.srcObject=null)},Q=function(){if(!S)return;S.classList.remove("muted");let t=document.getElementById("mute-button-text");t&&(t.textContent="Mute Mic");let i=document.getElementById("mute-button-icon");i&&(i.innerHTML=`
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            `)},de=function(t){let i=new TextDecoder().decode(t),r;try{r=JSON.parse(i)}catch{return}if(r.type==="avatar_talking_message"){r.message&&(u||y.clearCurrent(),y.append(r.message),y.outputStreaming("message","message--bot"));return}if(r.type==="avatar_end_message"){r.message&&(y.append(r.message),y.finalizeStreaming("message","message--bot"));return}if(r.type==="avatar_start_talking"){u=!0,h("Amy is speaking...",!0),n.isRecording&&n.stopRecording().catch(()=>{}),n.audioChunks=[],y.clearCurrent();return}if(r.type==="avatar_stop_talking"){u=!1,h("Please speak",!0),setTimeout(()=>{!v&&!u&&n.isActive()&&!n.isRecording&&!w&&n.startRecording().catch(()=>{})},500);return}},ue=function(t){(t.kind==="video"||t.kind==="audio")&&(T.addTrack(t.mediaStreamTrack),t.kind==="audio"&&t.source===LivekitClient.Track.Source.Camera&&he(t.mediaStreamTrack),T.getVideoTracks().length>0&&T.getAudioTracks().length>0&&(c.srcObject=T,n.isMobileDevice&&c&&c.play().catch(()=>{})))},he=function(t){try{let i=new(window.AudioContext||window.webkitAudioContext),r=i.createMediaStreamSource(new MediaStream([t]));A=i.createAnalyser(),A.fftSize=256,r.connect(A);let f=0,p=null;D=setInterval(()=>{let I=new Uint8Array(A.frequencyBinCount);A.getByteFrequencyData(I);let O=0;for(let z=0;z<I.length;z++)O+=I[z];let M=O/I.length/255;M>.01&&f<=.01&&!u&&(u=!0,h("Amy is speaking...",!0),n.isRecording&&n.stopRecording().catch(()=>{}),n.audioChunks=[],y.clearCurrent(),g.onAvatarSpeechStart?.()),M<=.01&&f>.01&&u?(p=p||Date.now(),Date.now()-p>500&&(u=!1,h("Please speak",!0),p=null,g.onAvatarSpeechEnd?.(),setTimeout(()=>{!v&&!u&&n.isActive()&&!n.isRecording&&!w&&n.startRecording().catch(()=>{})},500))):M>.01&&(p=null),f=M},100)}catch{}},me=function(t){let i=t.mediaStreamTrack;i&&T.removeTrack(i)},fe=function(t){},pe=function(){if(v){R.forEach(t=>{t&&(t.style.height="5%",t.style.background="linear-gradient(to top, #6b7280, #9ca3af)")});return}if(n&&n.analyser){let i=n.getAudioLevel()*100;R.forEach(r=>{if(!r)return;let f=(Math.random()-.5)*20,p=Math.max(5,i+f);r.style.height=`${Math.min(100,p)}%`,p>60?r.style.background="linear-gradient(to top, #ef4444, #f87171)":p>30?r.style.background="linear-gradient(to top, #f59e0b, #fbbf24)":r.style.background="linear-gradient(to top, #10b981, #34d399)"})}else R.forEach(t=>{if(!t)return;let i=Math.random()*30+10;t.style.height=`${i}%`,t.style.background="linear-gradient(to top, #10b981, #34d399)"})},ge=function(){Y(),_=setInterval(pe,100)},Y=function(){_&&(clearInterval(_),_=null)},h=function(t,i){let r=document.getElementById("voice-status");if(!r)return;let f=document.getElementById("voice-status-text"),p=document.getElementById("voice-indicator");f&&(f.textContent=t),i?(r.classList.add("active"),p&&(p.style.animation="pulse-voice 1.5s ease-in-out infinite")):(r.classList.remove("active"),p&&(p.style.animation="none"))},X=function(t){return t?(t.style.border="3px solid #10b981",setTimeout(()=>{t.style.border=""},2e3),t.onclick=async function(i){if(i.preventDefault(),i.stopPropagation(),P)return!1;P=!0,t.disabled=!0;try{await ce()}catch{o&&o.classList.remove("is-loading"),P=!1,t.disabled=!1,n.cleanup()}},!0):!1},ve=function(){we().then(({ip:t,location:i})=>{t&&m.initVisitor({ip:t,location:i,conversationId:m.conversationId}).then(()=>{}).catch(r=>{})}).catch(t=>{})},Se=function(t,i){return t&&i?`${t} - ${i}`:i||t||"unknown"},ke=function(t){return typeof t!="string"?!1:/^(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}$/.test(t.trim())},d=new j("main-chat-integration"),e=d.fetch(),s=await Ie("start-button")||document.getElementById("start-button"),o=document.getElementById("chatbox"),c=document.getElementById("mediaElement"),a=document.getElementById("close-button"),k=document.getElementById("task"),b=document.getElementById("chatbox-history"),E=document.getElementById("chatbox-form"),S=document.getElementById("mute-button"),H=document.getElementById("voice-button"),R=[document.getElementById("visualizer-bar-1"),document.getElementById("visualizer-bar-2"),document.getElementById("visualizer-bar-3"),document.getElementById("visualizer-bar-4"),document.getElementById("visualizer-bar-5"),document.getElementById("visualizer-bar-6"),document.getElementById("visualizer-bar-7"),document.getElementById("visualizer-bar-8")].filter(Boolean),T=new MediaStream,y=new V(b),m=new K(e.apiKey),n=new J,F=new N(d.getOpenAIApiKey()),q="Katya_Chair_Sitting_public",L="Hello and welcome. How can I help you today?",C={serverUrl:"https://api.heygen.com",apiKey:"NmIzYTk3ZjIyMTI1NDQxNWJlM2JkZWFlMjY2Njc0MzctMTc1OTY4MTY1MA==",avatarId:q,knowledgeBaseId:null,voiceId:null,intro:L};await ye(),ve();let B=[],v=!1,_=null,G=!1,W=!1,P=!1,w=!1,u=!1;async function ce(){await Z(),le(),o&&o.classList.add("open","is-loading");try{try{if(n.isMobileDevice&&(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia))throw new Error("getUserMedia not available. Please use HTTPS or localhost.");await n.initialize()}catch(t){if(n.isMobileDevice){let i=t.message||"Unknown error";throw h("Microphone permission required - please allow access",!1),new Error(`Microphone access denied: ${i}. Please allow microphone permissions and try again.`)}else throw t}n.onRecordingComplete=async t=>{if(v||w||u){n.audioChunks=[],!v&&!w&&!u&&n.isActive()&&setTimeout(async()=>{await n.startRecording()},500);return}if(t.size<2048){!v&&n.isActive()&&!u&&setTimeout(async()=>{await n.startRecording()},500);return}w=!0,h("Processing...",!1);try{let i=await F.transcribeAudio(t);i&&i.trim().length>3?(y.append(i),y.output("message","message--user"),m.sendMessage(i,!0).catch(()=>{}),B.push({role:"user",content:i}),g.sendText(i,"talk")):(w=!1,!v&&n.isActive()&&!u&&(h("Please speak",!0),setTimeout(async()=>{await n.startRecording()},500)))}catch{h("Error processing audio",!1),w=!1,!v&&n.isActive()&&!u&&setTimeout(async()=>{h("Please speak",!0),await n.startRecording()},1e3)}},n.onError=t=>{h("Microphone error - check permissions",!1)},await m.initUserConversation(),await g.createSession(),await g.startStreaming()}catch(t){throw h("Failed to start session",!1),o&&o.classList.remove("is-loading"),t}}async function Ae(t){try{h("Processing response...",!1);let i=await F.chatCompletion(t,B.slice(0,-1),C.intro||L),r="";await F.parseStreamingResponse(i,f=>{r+=f},()=>{m.sendMessage(r,!1).catch(()=>{}),B.push({role:"assistant",content:r}),g&&g.sessionInfo&&g.sendText(r,"repeat"),w=!1},f=>{u=!1,w=!1,h("Error getting response",!1)})}catch{u=!1,w=!1,h("Error getting response",!1)}}async function Z(){let t=[];g&&(g.sessionInfo||g.room||g.webSocket)&&t.push(g.closeSession().catch(i=>{})),m&&m.conversationId&&t.push(m.completeUserConversation().catch(i=>{})),t.length&&await Promise.all(t)}let A=null,D=null,g=new $(C,de,ue,me,fe);g.onAvatarSpeechStart=()=>{u=!0,h("Amy is speaking...",!0),n.isRecording&&n.stopRecording().catch(()=>{}),n.audioChunks=[],y.clearCurrent()},g.onAvatarSpeechEnd=()=>{u=!1,h("Please speak",!0),setTimeout(()=>{!v&&!u&&n.isActive()&&!n.isRecording&&!w&&n.startRecording().catch(()=>{})},500)};let U=!1;if(document.addEventListener("streamSessionStarted",async()=>{if(W=!0,P=!1,U=!1,s&&(s.disabled=!1,s.style.opacity="1"),o.classList.remove("is-loading"),n.isMobileDevice&&n.audioContext)try{n.audioContext.state==="suspended"&&await n.resumeAudioContext()}catch{}if(ge(),!v&&n.isActive())try{await n.startRecording(),h("Please speak",!0)}catch{h("Microphone error",!1)}U||(U=!0,setTimeout(()=>{let t=C.intro||L;g.sendText(t,"repeat")},200))}),document.addEventListener("streamSessionClosed",()=>{W=!1,P=!1,s&&(s.disabled=!1,s.style.opacity="1"),c&&(c.srcObject=null),o.classList.remove("open"),Y(),D&&(clearInterval(D),D=null),A&&(A=null),n.cleanup(),h("Voice stopped",!1),G=!1,v=!1,w=!1,u=!1,Q(),m&&m.completeUserConversation().catch(()=>{})}),S&&S.addEventListener("click",async function(){if(v=!v,v){S.classList.add("muted");let t=document.getElementById("mute-button-text");t&&(t.textContent="Unmute Mic");let i=document.getElementById("mute-button-icon");i&&(i.innerHTML=`
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>
            `),h("Voice muted",!1),n.isRecording&&await n.stopRecording()}else{v=!1,S.classList.remove("muted");let t=document.getElementById("mute-button-text");t&&(t.textContent="Mute Mic");let i=document.getElementById("mute-button-icon");if(i&&(i.innerHTML=`
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            `),h("Please speak",!0),W&&n.isActive()&&!w&&!u)try{await n.startRecording()}catch{}}}),window.addEventListener("beforeunload",function(t){if(m)try{m.completeUserConversation()}catch{}}),window.addEventListener("pagehide",function(t){if(m)try{m.completeUserConversation()}catch{}}),document.addEventListener("visibilitychange",function(){document.hidden&&m&&m.completeUserConversation()}),s)X(s);else{let t=new MutationObserver(r=>{let f=document.getElementById("start-button");f&&!f.onclick&&(X(f),t.disconnect())});t.observe(document.body,{childList:!0,subtree:!0});let i=document.querySelector('button[id="start-button"]')||document.querySelector("#start-button")||document.querySelector('button[aria-label*="start"]');i&&(X(i),t.disconnect())}a&&a.addEventListener("click",async function(){await Z()}),E&&E.addEventListener("submit",async t=>{t.preventDefault();let i=k.value.trim();i&&(y.append(i),y.output("message","message--user"),m.sendMessage(i,!0),B.push({role:"user",content:i}),g.sendText(i,"talk"),k.value="")});async function ye(){try{let t=await m.getAccountConfig();console.log("accountConfig",t),C.avatarId=t?.avatarId||q,C.knowledgeBaseId=t?.knowledgeBaseId??null,C.voiceId=t?.voiceId??null,C.intro=t?.intro||L}catch{C.avatarId=q,C.intro=L}}async function we(){try{let r=(await(await fetch("https://api.ipify.org?format=json")).json())?.ip;if(!ke(r))return{ip:null,location:"unknown"};let f="unknown";try{let p=await fetch(`https://ipapi.co/${r}/json/`);if(p.ok){let I=await p.json(),O=I?.city,M=I?.country_name||I?.country;f=Se(O,M)}}catch{f="unknown"}return{ip:r,location:f}}catch{return{ip:null,location:"unknown"}}}let ee=document.getElementById("chat-info-icon"),te=document.getElementById("chatbox-controls");if(ee&&te&&ee.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),te.classList.toggle("showing-info")}),n.isMobileDevice){let t=async()=>{await n.resumeAudioContext()};["click","touchstart","touchend"].forEach(i=>{document.addEventListener(i,t,{once:!0,passive:!0})}),o&&new MutationObserver(()=>{o.classList.contains("open")&&setTimeout(t,100)}).observe(o,{attributes:!0,attributeFilter:["class"]})}}catch{}})});export default Ee();
